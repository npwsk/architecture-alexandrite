# Выбор и настройка мониторинга в системе

## Мотивация

- **Раннее обнаружение проблем до жалоб клиентов**  
Без мониторинга команда реагирует только после жалоб. Это поздно. Система не может расти устойчиво без наблюдаемости.

- **Повышение доверия партнёров и клиентов**  
B2B-клиенты уже ушли из-за «пропавших» заказов. Мониторинг помогает выявить и устранить такие случаи заранее, сохранив контракты.

- **Прозрачность процессов внутри**  
Бизнесу важно знать, где теряются заказы, почему падает выручка, где перегружены операторы — без цифр это невозможно.

- **Основа для масштабирования**  
Чтобы планировать рост и увеличивать количество заказов, нужно понимать текущие пределы системы.

- **Снижение операционных затрат**  
Предотвращённый сбой дешевле устранённого. Мониторинг снижает время простоя и затраты на ручной разбор инцидентов.

## Выбор подхода к мониторингу

Для комплексной системы «Александрит» оптимально использовать комбинированный подход: применять разные модели мониторинга для разных компонентов, в зависимости от их роли в системе.


| Система                                              | Подход                                         | Обоснование                                                                                                     |
| ---------------------------------------------------- | ---------------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| MES (производственные расчёты)                       | Четыре золотых сигнала                         | MES — критический вычислительный компонент, важно контролировать и эффективность, и стабильность под нагрузкой. |
| RabbitMQ (взаимодействие между системами)            | USE                                            | RabbitMQ — инфраструктурный компонент, важно отслеживать его техническое состояние и «забитость».               |
| API и внешние интеграции (включая API для партнёров) | RED                                            | API — интерфейс для внешнего мира, здесь важна скорость и надёжность отклика.                                   |
| CRM и интерфейс MES (операторская часть)             | Четыре золотых сигнала + клиентский мониторинг | Операторы — важные пользователи, и их эффективность напрямую влияет на бизнес-результат.                        |
| Серверная инфраструктура и БД                        | USE                                            | Позволяет обнаруживать системные проблемы до их влияния на бизнес-функции.                                      |


Итого предлагается, использовать смешанный подход:

- Четыре золотых сигнала — для бизнес-критичных компонентов с пользовательской ценностью (MES, CRM)
- RED — для API-интерфейсов
- USE — для внутренних инфраструктурных компонентов (RabbitMQ, БД, сервера)

Такой выбор позволяет точечно покрыть все аспекты системы с фокусом на ценность для бизнеса и техническую устойчивость.

## Метрики для отслеживания

### RabbitMQ

1. Number of dead-letter-exchange letters in RabbitMQ  
    - Зачем: сигнализирует о потерянных/необработанных сообщениях — критично для заказов.
    - Ярлыки: queue_name, reason (например: timeout, format_error)
2. Number of messages in flight in RabbitMQ  
    - Зачем: показывает текущую нагрузку и позволяет увидеть «затор» в цепочке заказов.  
    - Ярлыки: queue_name

### API: Интернет-магазин, CRM, MES  

1. Number of requests (RPS) for shop API / CRM API / MES API  
    - Зачем: общая нагрузка на каждое API. Позволяет выявить пиковые моменты.  

    - Ярлыки: method, endpoint, status_code

2. Number of requests (RPS) per user for shop API / CRM API / MES API  
    - Зачем: помогает обнаружить злоупотребления, спам или аномальную активность.  

    - Ярлыки: user_id, endpoint, method  

3. Response time (latency) for shop API / CRM API / MES API  
    - Зачем: позволяет контролировать качество обслуживания и SLA.  

    - Ярлыки: endpoint, method, status_code  

4. Number of HTTP 500 for shop API / CRM API / MES API  
    - Зачем: главный индикатор внутренних ошибок. Особенно критично для MES.  

    - Ярлыки: endpoint, method, error_type (если возможно)  

### Ресурсы API-приложений  

1. CPU % и Memory Utilisation для shop / CRM / MES API  
    - Зачем: контроль загрузки сервисов, помогает в масштабировании и отладке производительности.
    - Ярлыки: instance_id, service_name  

### Базы данных  

1. Memory Utilisation for shop db / MES db instance  
    - Зачем: помогает выявить утечки памяти, неправильное кэширование, риски падения.

    - Ярлыки: db_name

2. Number of connections for shop db / MES db instance  
    - Зачем: перегрузка по соединениям может быть причиной ошибок и задержек.  

    - Ярлыки: db_name, service_name

3. Size of shop db / MES db instance
    - Зачем: контроль роста хранения, особенно при увеличении заказов и 3D-моделей.
    - Ярлыки: db_name  

### Сеть и трафик

1. Kb transferred (received) и Kb provided (sent) for shop / CRM / MES API  
    - Зачем: анализ пропускной способности и выявление перегрузок при обмене данными (особенно 3D-модели).

    - Ярлыки: service_name, endpoint  

### Дополнительные метрики (предлагаемые вне списка)  

1. Заказы в разрезе статусов (INITIATED → CLOSED)  
    - Зачем: понять, где зависают заказы.  

    - Ярлыки: status, source (shop/api), partner_id  

2. Время обработки одного заказа в MES (job duration)  
    - Зачем: контролировать расчёты стоимости.

    - Ярлыки: complexity, source, result (success/error/timeout)  

## План действий

1.  **Развернуть time-series базу данных (Prometheus)**
    
    *   Настроить retention, репликацию (если требуется), безопасность
        
    *   Обеспечить доступ для разработчиков и DevOps
        
2.  **Настроить визуализацию метрик (Grafana)**
    
    *   Установить Grafana, настроить datasource Prometheus
        
    *   Создать базовые дашборды для каждого сервиса
        
3.  **Настроить сбор метрик из RabbitMQ**
    
    *   Установить и настроить `rabbitmq_exporter`
        
    *   Подключить к Prometheus
        
    *   Настроить алерты по dead-letter и задержкам
        
4.  **Настроить сбор метрик из API-приложений**
    
    *   Интегрировать Prometheus middleware в Java Spring Boot (Shop, CRM)
        
    *   Интегрировать Prometheus middleware в C# backend MES
        
    *   Настроить метрики RPS, latency, errors (4xx/5xx), per user (если возможно)
        
5.  **Настроить сбор метрик с баз данных**
    
    *   Использовать `postgres_exporter` для Shop и MES БД
        
    *   Включить метрики по connections, memory, size
        
6.  **Настроить системные метрики для EC2-инстансов**
    
    *   Установить `node_exporter` на все сервисные машины
        
    *   Отслеживать CPU, RAM, disk usage

7.  **Добавить кастомные метрики в MES (расчёт стоимости)**
    
    *   Время расчёта
        
    *   Статус (успех/ошибка)
        
    *   Источник заказа (внутренний магазин или API-партнёр)
        
    *   Условная сложность модели
        
8.  **Добавить метрику по статусам заказов**
    
    *   Текущее количество заказов в каждом статусе (INITIATED, PRICE\_CALCULATED и т.д.)
        
    *   Время нахождения заказа в статусе
        
9.  **Добавить логирование и трекинг «пропавших» заказов**
    
    *   Логика: заказ не обновлялся > X минут на одном из промежуточных статусов

10.  **Настроить алерты в Grafana или Alertmanager**
     *   Dead-letter > 0
        
     *   Длительный расчёт > 10 минут
        
     *   Ошибки 5xx > N/мин
        
     *   Задержка API > 1 сек
        
     *   Очередь сообщений > порог
        
     *   Подвисшие заказы

11.  **Проверить корректность метрик и видимость в Grafana**

     *   Протестировать вручную или через нагрузочное тестирование
        
12.  **Документировать схему мониторинга**
    
     *   Список метрик, алертов, описание labels
        
     *   Гайд по доступу, поддержке и развитию
